<!DOCTYPE html>
<html>

<head>
    <title>Workbook Export Preview Simulator</title>
    <!-- Use local files or CDN for the test runner environment -->
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #222;
            color: #fff;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background: #0b5ed7;
        }

        #status {
            margin-top: 10px;
            color: #aaa;
        }
    </style>
    <script src="workbook_generators.js"></script>
    <script>
        // MOCK LIBRARY URLS (Same as taskpane.js)
        window.LIB_URLS = {
            jquery: "https://code.jquery.com/jquery-3.7.0.min.js",
            bootstrap_css: "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css",
            bootstrap_js: "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js",
            datatables_css: "https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css",
            datatables_js: "https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js",
            datatables_bs5_js: "https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js",
            buttons_css: "https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css",
            buttons_js: "https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js",
            buttons_bs5_js: "https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js",
            jszip: "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
            pdfmake: "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js",
            vfs_fonts: "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js",
            buttons_html5_js: "https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js",
            buttons_print_js: "https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js",
            buttons_colvis_js: "https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js",
            searchbuilder_css: "https://cdn.datatables.net/searchbuilder/1.5.0/css/searchBuilder.bootstrap5.min.css",
            searchbuilder_js: "https://cdn.datatables.net/searchbuilder/1.5.0/js/dataTables.searchBuilder.min.js",
            searchbuilder_bs5_js: "https://cdn.datatables.net/searchbuilder/1.5.0/js/searchBuilder.bootstrap5.min.js",
            dateTime_css: "https://cdn.datatables.net/datetime/1.5.1/css/dataTables.dateTime.min.css",
            dateTime_js: "https://cdn.datatables.net/datetime/1.5.1/js/dataTables.dateTime.min.js"
        };

        async function runTest() {
            const status = document.getElementById("status");
            status.textContent = "Fetching libs...";

            // 1. Generate MOCK WORKBOOK DATA (3 Sheets)
            // Sheet 1: Sales (Large)
            const sheet1 = [["Date", "Region", "Sales", "Profit"]];
            const regions = ["North", "South", "East", "West"];
            for (let i = 0; i < 50; i++) {
                sheet1.push([
                    `2024-01-${String(i + 1).padStart(2, '0')}`,
                    regions[i % 4],
                    (Math.random() * 5000).toFixed(2),
                    (Math.random() * 1000).toFixed(2)
                ]);
            }

            const sheet2 = [
                ["ID", "Name", "Role", "Department"],
                ["101", "Alice", "Manager", "HR"],
                ["102", "Bob", "Developer", "IT"],
                ["103", "Charlie", "Analyst", "Finance"]
            ];

            const sheet3 = [
                ["Product", "Stock", "Price"],
                ["Laptop", 50, 1200],
                ["Mouse", 200, 25],
                ["Monitor", 75, 300],
                ["Keyboard", 100, 45]
            ];

            const data = {
                "Sales_Summary": sheet1,
                "Employee_List": sheet2,
                "Inventory_Q1": sheet3
            };
            const sheetNames = ["Sales_Summary", "Employee_List", "Inventory_Q1"];
            const options = { workbookName: "Quarterly_Report_2024.xlsx" };

            // 2. Fetch Libs 
            const urls = window.LIB_URLS;
            const load = async (url) => (await fetch(url)).text();

            const cssKeys = ['bootstrap_css', 'datatables_css', 'buttons_css', 'searchbuilder_css', 'dateTime_css'];
            const jsKeys = [
                'jquery', 'bootstrap_js', 'datatables_js', 'datatables_bs5_js',
                'jszip', 'pdfmake', 'vfs_fonts',
                'buttons_js', 'buttons_bs5_js', 'buttons_colvis_js', 'buttons_html5_js', 'buttons_print_js',
                'dateTime_js', 'searchbuilder_js', 'searchbuilder_bs5_js'
            ];

            try {
                const [cssArr, jsArr] = await Promise.all([
                    Promise.all(cssKeys.map(k => load(urls[k]))),
                    Promise.all(jsKeys.map(k => load(urls[k])))
                ]);

                const libs = {
                    css: cssArr.join("\n"),
                    js: jsArr.join("\n")
                };

                status.textContent = "Generating HTML...";

                // CALL THE NEW FUNCTION
                const blob = generateWorkbookHTML(data, sheetNames, options, libs);
                const url = URL.createObjectURL(blob);

                // Show in Iframe
                const iframe = document.getElementById("preview-frame");
                iframe.src = url;
                iframe.style.display = "block";
                status.textContent = "Preview Loaded below.";
            } catch (e) {
                console.error(e);
                status.textContent = "Error: " + e.message;
            }
        }
    </script>
</head>

<body>
    <div
        style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px;">
        <h3>DataVista Workbook Export Simulator</h3>
        <button onclick="runTest()">Run with Dummy Sheets</button>
    </div>
    <div id="status">Ready.</div>
    <iframe id="preview-frame"
        style="width:100%; height:800px; border:1px solid #444; margin-top:20px; display:none; background:#fff;"></iframe>
</body>

</html>